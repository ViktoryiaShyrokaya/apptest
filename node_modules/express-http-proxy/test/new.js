var assert = require('assert');
var express = require('express');
var request = require('supertest');
var proxy = require('../');


describe('test intercept on html response',function() {
  'use strict';

  it('intercept', function(done) {
    var app = express();
    app.use(proxy('httpbin.org', {
      decorateRequest: function(reqOpt, req) {
        reqOpt.headers['Content-Type'] = 'text/html';
        return reqOpt;
      },
      intercept: function(targetRepsonse, data, req, res, cb) {
        debugger;
        data = data.toString().replace('Oh','<strong>Hey</strong>');
        assert(data !== '');
        cb(null, data);
      }
    }));

    request(app)
    .get('/html')
    .end(function(err, res) {
      debugger;
      if (err) { return done(err); }
      assert(res.body.indexOf('<strong>Hey</strong>') > -1);
    });

  });
});
